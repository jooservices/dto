name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.5'

jobs:
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for thorough secret scanning

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, json
          coverage: none

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3

      - name: Run Composer Audit
        run: composer audit

  lint:
    name: Lint - ${{ matrix.tool.name }}
    runs-on: ubuntu-latest
    needs: [security]  # Only run lints after security passes
    strategy:
      fail-fast: false
      matrix:
        tool:
          - name: Pint (Laravel Standard - TOP PRIORITY)
            command: pint:test
            priority: 1
          - name: PHPCS
            command: phpcs
            priority: 2
          - name: PHPStan
            command: phpstan
            priority: 3
          - name: PHPMD
            command: phpmd
            priority: 4
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, json
          coverage: none

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3

      - name: Run ${{ matrix.tool.name }}
        run: composer ${{ matrix.tool.command }}

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    needs: [security]  # Only run after security passes
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Optional: requires Dependency graph to be enabled in repo settings
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        # Note: This requires Dependency graph to be enabled in repository settings:
        # Settings → Code security and analysis → Dependency graph → Enable
        # If not enabled, this step will fail but won't block CI (continue-on-error: true)

  tests:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: [lint]  # Only run tests after lints pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, json
          coverage: pcov

      - name: Install Composer dependencies
        uses: ramsey/composer-install@v3

      - name: Run tests with coverage
        run: composer test:coverage

      - name: Check coverage threshold
        run: |
          COVERAGE=$(php -r "
            \$xml = simplexml_load_file('coverage.xml');
            \$metrics = \$xml->project->directory->totals->lines;
            echo round((float)\$metrics['percent'], 2);
          ")
          echo "Code coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "::error::Code coverage ${COVERAGE}% is below minimum threshold of 90%"
            exit 1
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true
          verbose: true

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/
            coverage.xml
          retention-days: 30

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [tests]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: .

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
